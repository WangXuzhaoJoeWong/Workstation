# Workstation：架构与开发目的（新对话快速衔接用）

## 1) Workstation 是什么

Workstation 是“应用工程”，用 MotionCore 的 ROS2-like 框架把具体业务服务跑起来。

当前典型形态：

- `workstation_arm_control_service`：控制机械臂（对接厂商 SDK），提供控制面与状态发布。
- `workstation_bt_service`：运行行为树（BT），通过发布命令 + 订阅状态驱动业务流程。

## 2) 设计目标

- 可部署：systemd 友好，env 注入配置，易运维。
- 可观测：统一日志/metrics/trace 传播，遇到问题能快速定位是“设备侧 gate”还是“通信/线程模型/退出稳定性”。
- 可演进：业务节点/BT XML 可热更新，服务间契约（EventDTO）兼容演进。

## 3) 核心架构（最小心智模型）

- 统一通信与线程模型：
  - DDS 层使用 MotionCore 的 `EventDtoPublisher` / `EventDtoSubscription`（而不是业务代码手写 FastDDS + CDR）。
  - listener 回调不做业务处理；回调投递到 `ingress_strand`，主循环 tick/spin 驱动。

- arm_control：
  - 输入：订阅 `/arm/command`（EventDTO）
  - 处理：SDK 调用在 `arm_sdk_strand` 串行，避免并发重入
  - 输出：发布 `/arm/status`（EventDTO）

- bt_service：
  - 运行 BT tree
  - 在节点里发布 `/arm/command`，并订阅 `/arm/status` 写入缓存，供节点轮询等待

## 4) 关键代码路径（遇到问题先看这几个文件）

- bt_service：
  - 入口与主循环：[Workstation/services/bt_service/src/app.cpp](../services/bt_service/src/app.cpp)
  - DDS pub/sub 创建：[Workstation/services/bt_service/src/dds_channels.cpp](../services/bt_service/src/dds_channels.cpp)
  - arm_status 缓存更新：[Workstation/services/bt_service/src/arm_status_cache.cpp](../services/bt_service/src/arm_status_cache.cpp)
  - BT 节点实现：[Workstation/services/bt_service/src/arm_nodes.cpp](../services/bt_service/src/arm_nodes.cpp)

- arm_control：
  - 入口与 wiring：[Workstation/services/arm_control/src/app.cpp](../services/arm_control/src/app.cpp)
  - SDK 封装与运动实现（moveL/moveJ）：[Workstation/services/arm_control/src/arm_control_internal.cpp](../services/arm_control/src/arm_control_internal.cpp)

## 5) 常见现场问题速查：move_error(18) 怎么看

`move_error=18`（厂商 SDK：阻塞运动返回的移动状态错误）通常不是“架构不稳定”，而是“控制器状态/模式/互锁/安全 gating”导致的拒绝。

现场常见解除顺序（从最常见到最致命）：

- 解除急停/安全停（ProtectiveStop/Imdstop）
- 清故障（Fault Reset）
- 上电 + 使能（PowerOn/Enable）
- 切到 POSITION 控制模式（controlMode=0）
- 速度百分比 > 0

## 6) 新开对话快速衔接模板（复制到新对话第一条）

- 我在 wxz_robot workspace 中开发：MotionCore（SDK）+ Workstation（应用）。
- 目标：<一句话>
- 现象：<一句话 + 1 行关键日志>
- 已做改动：<文件 + 1 行说明>
- 关键路径：
  - arm_control：Workstation/services/arm_control/src/arm_control_internal.cpp
  - bt_service：Workstation/services/bt_service/src/app.cpp
- 我希望你接下来做：<例如：给现场解除步骤/加预检/跑 build/查 ldd>
