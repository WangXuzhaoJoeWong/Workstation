# 快速开始（编译/运行）

## 1) 编译

Workstation 是独立工程，推荐依赖已安装的 MotionCore（`find_package(MotionCore CONFIG REQUIRED)`）。

先构建并安装 MotionCore（默认安装到 MotionCore/build 目录本身）：

```bash
WS=$(pwd)

cd MotionCore
mkdir -p build
cd build

cmake .. -DCMAKE_BUILD_TYPE=Release
make -j"$(nproc)"
./install.sh
```

再独立构建 Workstation：

```bash
WS=$(pwd)
cd Workstation
mkdir -p build
cd build

cmake .. \
  -DCMAKE_BUILD_TYPE=Release \
  -DCMAKE_PREFIX_PATH="$WS/MotionCore/build" \
  -DWXZ_WORKSTATION_ENABLE_BT=ON \
  -DWXZ_WORKSTATION_BT_FETCHCONTENT=ON
make -j"$(nproc)"

# 安装到 build 目录本身（不创建额外 install 文件夹）
./install.sh
```

说明：
- 如果不想 FetchContent 拉取 BT 依赖，可改用 `-DWXZ_WORKSTATION_BT_ROOT=/path/to/BehaviorTree.CPP`。
- 生成的可执行文件：
  - `Workstation/build/workstation_arm_control_service`
  - `Workstation/build/workstation_bt_service`

## 2) 运行（本机前台）

最简单方式：两个独立终端分别启动两个服务。

终端 A（arm_control）：

```bash
WS=$(pwd)
BUILD_DIR=$WS/Workstation/build
MOTIONCORE_PREFIX=$WS/MotionCore/build

set -a
source $WS/Workstation/resources/workstation.env.sample
# 或者：source /etc/workstation/workstation.env
set +a

# arm SDK 动态库路径（按需调整）
export LD_LIBRARY_PATH="$WS/depends/CGXi_Robot_SDK/libs:${MOTIONCORE_PREFIX}/lib:${LD_LIBRARY_PATH:-}"

$BUILD_DIR/workstation_arm_control_service
```

终端 B（bt_service）：

```bash
WS=$(pwd)
BUILD_DIR=$WS/Workstation/build
MOTIONCORE_PREFIX=$WS/MotionCore/build

set -a
source $WS/Workstation/resources/workstation.env.sample
set +a

export LD_LIBRARY_PATH="${MOTIONCORE_PREFIX}/lib:${LD_LIBRARY_PATH:-}"

$BUILD_DIR/workstation_bt_service
```

## 2.1) 常用环境变量（建议先看）

Workstation 当前统一只支持 env 注入配置（不读 YAML）。推荐使用：

- 开发/本机：`source Workstation/resources/workstation.env.sample`
- 部署/现场：复制为 `/etc/workstation/workstation.env`，由 systemd `EnvironmentFile=` 加载

常用项（单位/建议值）：

- `WXZ_DOMAIN_ID`：DDS domain id（两个服务必须一致）
- `WXZ_BT_TICK_MS`：BT tick 周期（ms）；常用 10~50
- `WXZ_BT_RELOAD_MS`：BT XML 热加载检查周期（ms）；常用 200~1000
- `WXZ_ARM_CMD_TIMEOUT_MS`：BT 节点等待 arm/status 的超时（ms）；常用 30000

机械臂连接（arm_control）：

- `WXZ_ARM_IP` / `WXZ_ARM_PORT` / `WXZ_ARM_PASS`
- 排障：如果连接/动作超时，优先检查网线/路由与端口（例如 `ping` + `nc -vz <ip> <port>`）

运动安全/调试（强烈建议先用）：

- `WXZ_ARM_DRY_RUN=1`：只打印 move 参数，不下发运动（用于验证单位/目标点，避免“乱飞”）
- `WXZ_ARM_ALLOW_LARGE_ANGLE=1` / `WXZ_ARM_ALLOW_LARGE_JOINT=1`：放开角度大值保护（默认关闭，不建议开启）

## 2.2) Metrics（可抓取 /metrics）

两个服务都支持可选启用 HTTP `/metrics`。

本机验证（默认端口）：

- bt_service：`curl -fsS http://127.0.0.1:9100/metrics | head`
- arm_control：`curl -fsS http://127.0.0.1:9101/metrics | head`

开关/端口覆盖与 Prometheus 抓取示例见：[06_观测与故障恢复.md](06_观测与故障恢复.md)

## 3) 最小验证

1) 确认两个进程都在跑：
- `arm_control` 输出里应看到 `start ip=... domain=... cmd='...' status='...'`
- `bt_service` 输出里应看到 `start domain=... xml='...' tick_ms=... reload_ms=...`

1) 编辑 BT XML（默认：`Workstation/resources/bt.xml`），保存后应看到 bt_service 触发热加载日志（`tree loaded`）。

说明：
- `bt_service` 固定从当前工作目录读取 `./bt.xml`（相对路径），不会读取 `WXZ_BT_XML`。
- 推荐在 `Workstation/build` 下放一个 `bt.xml`（可用软链接指向 `Workstation/resources/bt.xml`）。

更多配置项与话题/schema 约束见：`02_配置项.md`。

