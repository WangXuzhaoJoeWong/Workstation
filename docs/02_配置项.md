# 配置项（env/话题/schema）

本文把环境变量按服务分组。所有配置都可以通过 env 注入：
- 本地终端：`export` / `source workstation.env`
- systemd override：见 [05_部署_systemd.md](05_部署_systemd.md)

## A. 通用（两个服务都用）

- `WXZ_DOMAIN_ID`：FastDDS domain id
- `WXZ_SW_VERSION`：capability/status 的 version 字段
- `WXZ_CAPABILITY_STATUS_TOPIC`：默认 `capability/status`
- `WXZ_HEALTH_FILE`：健康文件路径（空字符串表示禁用）
- `WXZ_LOG_LEVEL`：`error|warn|info|debug` 或 `0|1|2|3`
- `WXZ_DTO_SOURCE`：写入 EventDTO meta 的 source（各服务默认不同）
- `WXZ_DTO_MAX_PAYLOAD`：EventDTO CDR 最大 payload（默认 8192）

## A.4 Metrics 导出（logger/文件 + HTTP /metrics）

Workstation 默认不启动 metrics 导出；需要显式开启。

总开关：

- `WXZ_METRICS_EXPORT_ENABLE`：1 启用 metrics sink（默认 0）

周期导出（写日志或写文件）：

- `WXZ_METRICS_EXPORT_PERIOD_MS`：导出周期（ms，默认 5000；也兼容 `WXZ_METRICS_PERIOD_MS`）
- `WXZ_METRICS_EXPORT_PATH`：非空则写入该文件；为空则写入日志

HTTP `/metrics`：

- `WXZ_METRICS_HTTP_ENABLE`：1 启用 HTTP server（默认 0）
- `WXZ_METRICS_HTTP_ADDR`：bind addr（默认 `0.0.0.0`）
- `WXZ_METRICS_HTTP_PORT`：端口（bt_service 默认 9100；arm_control 默认 9101）
- `WXZ_METRICS_HTTP_PATH`：路径（默认 `/metrics`）

提示：两个服务读取相同 env key。

- 如果两个服务共用同一份 `EnvironmentFile=`，建议不要在全局 env 文件里设置 `WXZ_METRICS_HTTP_PORT`，让它们使用各自默认端口（9100/9101）。
- 如需单独改端口，建议用 systemd per-unit `Environment=` 覆盖。

## A.5 故障恢复（可选：restart/degrade）

默认建议交给外部 supervisor（systemd）负责重启。本仓库提供 `FaultRecoveryExecutor` 作为可选策略：订阅 `fault/status`，匹配后执行 restart/degrade。

- `WXZ_FAULT_RECOVERY_ENABLE`：1 启用（默认 0）

匹配条件：

- `WXZ_FAULT_RECOVERY_MATCH_SERVICE`：默认是当前 service 名称
- `WXZ_FAULT_RECOVERY_MATCH_FAULT`：默认空（不限制 fault 字段）
- `WXZ_FAULT_RECOVERY_SEVERITY`：默认 `fatal`，支持逗号分隔（例如 `fatal,error`）

动作：

- `WXZ_FAULT_RECOVERY_ACTION`：`restart` 或 `degrade`（默认 `restart`）
- `WXZ_FAULT_RECOVERY_EXIT_CODE`：restart 时使用的退出码（默认 77；0 会回退为 77）
- `WXZ_FAULT_RECOVERY_MARKER_FILE`：degrade 时写入 marker 文件（默认 `/tmp/wxz_degraded`）

### A.1 FastDDS 传输兜底（推荐了解）

在某些环境（容器、/dev/shm 配额/权限、残留 fastrtps 段等）下，FastDDS 的 Shared Memory 传输可能导致启动阶段异常。
为提升可部署性，可以强制只使用 UDPv4 传输（完全避开 SHM）：

- `WXZ_FASTDDS_FORCE_UDP_ONLY`：1 表示强制 UDP-only（推荐使用）
- `WXZ_FASTDDS_DISABLE_SHM`：1 表示禁用 SHM（历史兼容别名，效果同上）

如何确认生效：启动日志会打印类似一行（不同服务前缀不同）

- `FastDDS participant transport phase=precreate_udp_only ... use_builtin_transports=0 user_transports=1`

如果没开 UDP-only，则通常会看到：

- `phase=precreate_default ... use_builtin_transports=1 user_transports=0`

### A.2 尝试启用 SHM（性能优化项，按需执行）

Shared Memory（SHM）通常用于“同机进程间”高吞吐/低延迟通信；但它对部署环境更敏感（容器、/dev/shm 配额/权限、残留段、FastDDS 版本差异等）。

建议策略：

- 默认先用 UDP-only 跑稳定性（必要时打开 `WXZ_FASTDDS_FORCE_UDP_ONLY=1` 作为兜底）。
- 当业务确实需要性能（例如大消息/高频率导致 UDP-only CPU 或延迟不达标）再尝试启用 SHM。

执行步骤（推荐最小闭环）：

1) 保持可回退：上线/压测时保留 `WXZ_FASTDDS_FORCE_UDP_ONLY=1` 作为“一键回退开关”。
2) 做 A/B 对比：同一套服务分别用“默认传输（允许 SHM）”与“UDP-only”跑相同的 soak/压测，对比 CPU、端到端延迟、丢包/匹配情况。
3) 针对环境治理（常见有效项）：
  - 容器：显式配置 `/dev/shm`（例如 Docker 的 `--shm-size`），必要时使用 `--ipc=host` 避免 IPC 隔离导致 SHM 行为异常。
  - 系统：确保 `/dev/shm` 空间与 inode 充足；出现异常时，在确认无相关进程后清理残留段（常见前缀 `fastrtps_*`）。
  - 配置：使用 FastDDS XML profiles 显式控制 transport（例如 SharedMemTransport 的 segment/port 参数），避免依赖默认值在特定环境踩坑。
4) 观测闭环：
  - 通过日志确认实际传输策略（见 A.1 的 transport 日志）。
  - 若出现启动期异常，优先记录：容器参数、`df -h /dev/shm`、`ls -l /dev/shm | grep fastrtps`、FastDDS 版本信息。

风险提示：

- “栈顶出现在 SharedMemTransport”不一定代表 SHM 是根因；内存破坏（UB）也可能让异常在该处被触发。
- 因此在尝试 SHM 前，先确保业务侧代码已消除悬空引用/越界写等 UB（否则排障会非常困难）。

### A.3 FastDDS XML Profiles 示例（可选）

当你需要更精细地控制 FastDDS transport（例如启用/调参 SHM），可以用 XML profiles。Workstation/MotionCore 支持通过 env 指定 profiles 文件与 participant profile：

- `WXZ_FASTDDS_PROFILES_FILE`：指向 XML 文件路径
- `WXZ_FASTDDS_PARTICIPANT_PROFILE`：指定 participant profile 名称

示例（仅示意，参数需按环境调整；建议先在测试环境 A/B 验证）：

```xml
<?xml version="1.0" encoding="UTF-8"?>
<profiles xmlns="http://www.eprosima.com/XMLSchemas/fastRTPS_Profiles">
  <!-- 1) UDP-only：完全禁用 builtin transports，只保留 UDPv4 -->
  <participant profile_name="wxz_udp_only" is_default_profile="false">
    <rtps>
      <userTransports>
        <transport_id>udp_v4</transport_id>
      </userTransports>
      <useBuiltinTransports>false</useBuiltinTransports>
    </rtps>
  </participant>

  <!-- 2) SHM + UDP：在同机可用 SHM，提高吞吐；同时保留 UDP 以提升兼容性/跨机能力 -->
  <participant profile_name="wxz_shm_plus_udp" is_default_profile="false">
    <rtps>
      <userTransports>
        <transport_id>udp_v4</transport_id>
        <transport_id>shm</transport_id>
      </userTransports>
      <useBuiltinTransports>false</useBuiltinTransports>
    </rtps>
  </participant>

  <transport_descriptors>
    <transport_descriptor>
      <transport_id>udp_v4</transport_id>
      <type>UDPv4</type>
    </transport_descriptor>
    <transport_descriptor>
      <transport_id>shm</transport_id>
      <type>SHM</type>
      <!-- 这里通常需要根据 /dev/shm 配额、并发与消息大小做调参；不同 FastDDS 版本字段可能不同 -->
    </transport_descriptor>
  </transport_descriptors>
</profiles>
```

使用方式：

- UDP-only：设置 `WXZ_FASTDDS_PROFILES_FILE=/path/to/fastdds.xml` 且 `WXZ_FASTDDS_PARTICIPANT_PROFILE=wxz_udp_only`
- SHM+UDP：设置 `WXZ_FASTDDS_PARTICIPANT_PROFILE=wxz_shm_plus_udp`

注意：即使使用 profiles，也建议保留 `WXZ_FASTDDS_FORCE_UDP_ONLY=1` 作为紧急回退开关。

## B. 话题与 schema（arm_control ↔ bt_service）

两边必须一致：

- `WXZ_P1_ARM_COMMAND_TOPIC`：默认 `/arm/command`
- `WXZ_P1_ARM_STATUS_TOPIC`：默认 `/arm/status`

schema 主要由 arm_control 校验，bt_service 负责按配置写入：

- `WXZ_ARM_CMD_DTO_SCHEMA`
  - arm_control 默认 `ws.arm_command.v1`
  - bt_service 默认当前实现为 `ws.arm_command.v1`（由 bt_service 的配置加载决定）
- `WXZ_ARM_STATUS_DTO_SCHEMA`
  - arm_control 默认 `ws.arm_status.v1`
  - bt_service 目前不强制校验 status schema（它直接解析 payload KV）

## C. arm_control 服务（workstation_arm_control_service）

机械臂 SDK 连接：
- `WXZ_ARM_IP`（默认 192.168.100.88；本地脚本默认 127.0.0.1）
- `WXZ_ARM_PORT`（默认 2323）
- `WXZ_ARM_PASS`（默认 123）

运动指令单位约定（强烈建议遵守，否则可能导致“乱飞”）：
- `moveL/moveLine`：
  - `pose`：`x,y,z,Rx,Ry,Rz`，其中 `x/y/z` 单位 `mm`，`R*` 单位 `rad`
  - `jointpos`：6 关节角，单位 `rad`（作为 seed）
  - `speed`：单位 `mm/s`（建议先用较小值验证方向/坐标系）
- `moveJ/moveJoint`：
  - `jointpos`：单位 `rad`
  - `speed`：单位 `rad/s`

运动安全/调试（建议先 dry-run 再真机动作）：
- `WXZ_ARM_DRY_RUN`：1 表示只打印计算后的参数，不下发运动（默认 0）
- `WXZ_ARM_ALLOW_LARGE_ANGLE`：允许姿态角出现“疑似错误的大值”（默认 0，不建议打开）
- `WXZ_ARM_ALLOW_LARGE_JOINT`：允许关节角出现“疑似错误的大值”（默认 0，不建议打开）

告警（fault/status & fault/action）：
- `WXZ_FAULT_STATUS_TOPIC`（默认 `fault/status`）
- `WXZ_FAULT_ACTION_TOPIC`（默认 `fault/action`）

队列：
- `WXZ_ARM_QUEUE_MAX`（默认 64）

## D. bt_service 服务（workstation_bt_service）

BT 运行时：
- `WXZ_BT_TICK_MS`：tick 周期（ms，默认 20）
- `WXZ_BT_RELOAD_MS`：XML 热加载检查周期（ms，默认 500）

说明：
- bt_service 固定从当前工作目录读取 `./bt.xml`（相对路径），不会读取 `WXZ_BT_XML`（该变量已废弃/忽略）。

arm 命令超时：
- `WXZ_ARM_CMD_TIMEOUT_MS`：BT 节点等待 `/arm/status` 的默认超时（默认 30000）

system alert（由 bt_service 发布）：
- `WXZ_SYSTEM_ALERT_TOPIC`：默认 `/system/alert`
- `WXZ_SYSTEM_ALERT_DTO_SCHEMA`：默认 `ws.system_alert.v1`

Groot1（可选，编译期探测到 ZMQ publisher 头文件时启用）：
- `WXZ_BT_GROOT`：0/1
- `WXZ_BT_GROOT_PORT`：默认 1666
- `WXZ_BT_GROOT_SERVER_PORT`：默认 `WXZ_BT_GROOT_PORT+1`
- `WXZ_BT_GROOT_RETRY`：默认 5
- `WXZ_BT_GROOT_MAX_MSG_PER_SEC`：默认 25

