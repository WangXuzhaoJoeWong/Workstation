# 架构与数据流（arm_control ↔ bt_service）

## 1) 组件

- `workstation_arm_control_service`
  - 订阅 `/arm/command`（EventDTO CDR bytes）
  - 执行机械臂 SDK 操作（MoveL/MoveJ/…）
  - 发布 `/arm/status`（EventDTO CDR bytes）

- `workstation_bt_service`
  - 加载并周期热更新 BT XML
  - 运行 BT tree
  - 在 BT 节点中发布 `/arm/command`
  - 订阅 `/arm/status` 并写入 `ArmRespCache`，供 BT 节点轮询等待

## 2) 话题与消息格式

- 传输：FastDDS（由 MotionCore 封装在 `EventDtoPublisher` / `EventDtoSubscription` 内）
- payload：`EventDTO` 的 CDR 编码（由 MotionCore 统一完成编码/解码与 buffer pool 管理）
- EventDTO.payload：KV 字符串（`k=v;...`，由 `EventDTOUtil::buildPayloadKv/parsePayloadKv` 构造/解析）

### 命令与状态的关联

核心字段是 `id`：

- bt_service 发送命令时生成 `id`（或沿用上层传入），写入 payload KV。
- arm_control 处理命令后，在 `/arm/status` payload KV 中回填同一个 `id`。
- bt_service 订阅 `/arm/status` 的回调把响应写入 `ArmRespCache`，以 `id` 为 key。
- BT action 节点在 `onRunning()` 里通过 `id` 轮询 cache，直到成功/失败/超时。

## 3) 关键代码位置

### bt_service 侧

- 配置加载（env → cfg）：[Workstation/services/bt_service/src/app_config.cpp](Workstation/services/bt_service/src/app_config.cpp)
- DDS pub/sub 创建：`arm_cmd_dto_pub` / `arm_status_dto_sub`：[Workstation/services/bt_service/src/dds_channels.cpp](Workstation/services/bt_service/src/dds_channels.cpp)
- 订阅回调（arm_status → ArmRespCache）：[Workstation/services/bt_service/src/arm_status_cache.cpp](Workstation/services/bt_service/src/arm_status_cache.cpp)
- BT 节点注册 wiring：把通道与 cache 注入节点：[Workstation/services/bt_service/src/arm_wiring.cpp](Workstation/services/bt_service/src/arm_wiring.cpp)
- BT 节点实现：发布命令、等待状态、输出端口等：[Workstation/services/bt_service/src/arm_nodes.cpp](Workstation/services/bt_service/src/arm_nodes.cpp)

### arm_control 侧

- 配置加载（env）：[Workstation/services/arm_control/src/app.cpp](Workstation/services/arm_control/src/app.cpp)
- 订阅回调与主循环（/arm/command + /arm/status）：[Workstation/services/arm_control/src/app.cpp](Workstation/services/arm_control/src/app.cpp)
  - 订阅回调：decode EventDTO → 校验 schema → payload 入队（回调运行在 ingress_strand）
  - 主循环：出队 → processor 处理（SDK 在 arm_sdk_strand 串行）→ 发布 `/arm/status`

## 4) 时序（简化）

1. BT tree tick 到某个 arm action 节点
2. bt_service 节点发布 `/arm/command`（KV 中包含 `op` + `id` + 参数）
3. arm_control 的 subscribe 回调收到命令，入队
4. arm_control 出队执行 SDK，生成响应 KV（`ok/err_code/err/sdk_code/...`），发布 `/arm/status`
5. bt_service 的 subscribe 回调收到 status，把响应写入 `ArmRespCache[id]`
6. BT 节点轮询到响应，返回 SUCCESS/FAILURE

