# 观测与故障恢复（/metrics + fault recovery）

本页给出 Workstation 两个服务的“可抓取 metrics”与“可选故障恢复执行器”的最小闭环。

## 1) Metrics：两种导出方式

两种方式可以同时开启：

- 周期导出（写日志或写文件）：适合快速排障、离线采集
- HTTP `/metrics`（Prometheus exposition text）：适合 Prometheus 抓取

### 1.1 开关与参数（两个服务通用）

开启 metrics 体系的总开关：

- `WXZ_METRICS_EXPORT_ENABLE=1`

周期导出（logger/文件）：

- `WXZ_METRICS_EXPORT_PERIOD_MS`：周期（ms），默认 5000（也兼容 `WXZ_METRICS_PERIOD_MS`）
- `WXZ_METRICS_EXPORT_PATH`：非空则写入该文件；为空则写入日志

HTTP `/metrics`：

- `WXZ_METRICS_HTTP_ENABLE=1`
- `WXZ_METRICS_HTTP_ADDR`：默认 `0.0.0.0`
- `WXZ_METRICS_HTTP_PORT`：
  - bt_service 默认 `9100`
  - arm_control 默认 `9101`
- `WXZ_METRICS_HTTP_PATH`：默认 `/metrics`

重要提示（端口冲突）：

- 两个服务读取的是同一组 env key。
- 如果你用同一份 `EnvironmentFile=` 同时启动两个服务，建议**不要**在全局 env 文件里设置 `WXZ_METRICS_HTTP_PORT`，让它们使用各自的默认值（9100/9101）。
- 如果确实要改端口，建议用 systemd 的 per-unit `Environment=` 单独覆盖。

### 1.2 本机验证（curl）

bt_service：

```bash
curl -fsS http://127.0.0.1:9100/metrics | head
```

arm_control：

```bash
curl -fsS http://127.0.0.1:9101/metrics | head
```

### 1.3 Prometheus 抓取示例

`prometheus.yml`（片段）：

```yaml
scrape_configs:
  - job_name: workstation_bt_service
    metrics_path: /metrics
    static_configs:
      - targets: ['127.0.0.1:9100']

  - job_name: workstation_arm_control_service
    metrics_path: /metrics
    static_configs:
      - targets: ['127.0.0.1:9101']
```

如果改了 `WXZ_METRICS_HTTP_PATH`，同步修改 `metrics_path`。

## 2) Fault recovery：默认建议交给外部 supervisor

Workstation 的 unit 示例本身已经是“外部 supervisor”（systemd）模型：

- `Restart=always`
- 服务退出后自动拉起

本仓库提供一个**可选**的 `FaultRecoveryExecutor`，用于在收到 `fault/status` 的某些事件时：

- `restart`：请求进程退出（带 exit code），让 supervisor 拉起
- `degrade`：写入 marker 文件（例如 `/tmp/wxz_degraded`），供外部系统感知/降级

### 2.1 开关与参数

- `WXZ_FAULT_RECOVERY_ENABLE=1`

匹配条件（匹配到才触发动作）：

- `WXZ_FAULT_RECOVERY_MATCH_SERVICE`：默认是当前 service 名称
- `WXZ_FAULT_RECOVERY_MATCH_FAULT`：默认空（不限制 fault 字段）
- `WXZ_FAULT_RECOVERY_SEVERITY`：默认 `fatal`，支持逗号分隔（例如 `fatal,error`）

动作：

- `WXZ_FAULT_RECOVERY_ACTION`：`restart` 或 `degrade`（默认 `restart`）
- `WXZ_FAULT_RECOVERY_EXIT_CODE`：restart 时使用的退出码（默认 77；0 会回退为 77）
- `WXZ_FAULT_RECOVERY_MARKER_FILE`：degrade 时写入的 marker 文件（默认 `/tmp/wxz_degraded`）

### 2.2 systemd 建议用法

推荐方式：保持 `Restart=always`，只把“何时退出/降级”的策略写在 env。

- 如果希望 bt_service 收到 fatal fault 就退出并由 systemd 拉起：

```ini
Environment=WXZ_FAULT_RECOVERY_ENABLE=1
Environment=WXZ_FAULT_RECOVERY_ACTION=restart
Environment=WXZ_FAULT_RECOVERY_SEVERITY=fatal
```

- 如果希望 arm_control 收到 fatal/error fault 就写 marker（不退出）：

```ini
Environment=WXZ_FAULT_RECOVERY_ENABLE=1
Environment=WXZ_FAULT_RECOVERY_ACTION=degrade
Environment=WXZ_FAULT_RECOVERY_SEVERITY=fatal,error
Environment=WXZ_FAULT_RECOVERY_MARKER_FILE=/tmp/wxz_arm_degraded
```

注意：如果两个服务共用同一份 `EnvironmentFile=`，但希望它们采用不同的 fault recovery 策略，建议同样用 per-unit 的 `Environment=` 做覆盖。
